import asyncio
import logging

from aiogram import types
from aiogram.dispatcher.filters.builtin import CommandStart
from aiogram.dispatcher import FSMContext

from handlers.users.libs import docs
from keyboards.inline.main_inline import *
from keyboards.inline.menu_button import *
from loader import dp, bot
from utils.db_api.database import *
import datetime
from aiogram.types import ReplyKeyboardRemove
from geopy.geocoders import Nominatim
from aiogram.utils.deep_linking import decode_payload, get_start_link
import re
import requests
from docx import Document
from docx2pdf import convert
from get_valute import valyuta_kurslari
import os


def isValid(s):
    Pattern = re.compile("(0|91)?[7-9][0-9]{9}")
    return Pattern.match(s)


async def send_sms(otp, phone):
    username = 'bestbrok'
    password = 'tM4!-hmV52Z@'
    sms_data = {
        "messages": [{"recipient": f"{phone}", "message-id": "abc000000003", "sms": {"originator": "3700", "content":
        {"text": f"Ğ’Ğ°Ñˆ ĞºĞ¾Ğ´ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ñ Ğ´Ğ»Ñ BEST BROK BOT: {otp}"}}}]}
    url = "http://91.204.239.44/broker-api/send"
    res = requests.post(url=url, auth=(username, password), json=sms_data)
    print(res)


async def generateOTP():
    return random.randint(111111, 999999)


@dp.message_handler(commands=["menu"], state="*")
async def add_datas(message: types.Message, state: FSMContext):
    user = await get_user(message.from_id)
    if user is not None:
        if user.lang:
            lang = await get_lang(message.from_user.id)
            if user.phone:
                markup = await user_menu(lang)
                if lang == "uz":
                    await message.answer("Botimizga xush kelibsiz. Iltimos kerakli bo'limni tanlang ğŸ‘‡", reply_markup=markup, protect_content=True)
                elif lang == "ru":
                    await message.answer("Ğ”Ğ¾Ğ±Ñ€Ğ¾ Ğ¿Ğ¾Ğ¶Ğ°Ğ»Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ² Ğ½Ğ°Ñˆ Ğ±Ğ¾Ñ‚. Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ½ÑƒĞ¶Ğ½Ñ‹Ğ¹ Ñ€Ğ°Ğ·Ğ´ĞµĞ»ğŸ‘‡", reply_markup=markup, protect_content=True)
                elif lang == "en":
                    await message.answer("Welcome to our bot. Please select the desired section ğŸ‘‡", reply_markup=markup, protect_content=True)
                await state.set_state("get_category")
            else:
                markup = await back_to_keyboard(lang)
                if lang == "uz":
                    await message.answer("Iltimos ismingizni kiriting ğŸ‘‡", reply_markup=markup, protect_content=True)
                elif lang == "ru":
                    await message.answer("ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ²Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ²Ğ°ÑˆĞµ Ğ¸Ğ¼Ñ ğŸ‘‡", reply_markup=markup, protect_content=True)
                elif lang == "en":
                    await message.answer("Please enter your name ğŸ‘‡", reply_markup=markup, protect_content=True)
                await state.set_state("get_name")
                
        else:
            markup =await language_keyboard()
            await message.answer(f"Assalomu alaykum, {message.from_user.first_name}ğŸ‘‹. \nKerakli tilni tanlang ğŸ‘‡\n\nHello, {message.from_user.first_name}ğŸ‘‹. \nChoose the language you need ğŸ‘‡\n\nĞ—Ğ´Ñ€Ğ°Ğ²ÑÑ‚Ğ²ÑƒĞ¹Ñ‚Ğµ, {message.from_user.first_name}ğŸ‘‹. \nĞ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ½ÑƒĞ¶Ğ½Ñ‹Ğ¹ ÑĞ·Ñ‹Ğº ğŸ‘‡", 
